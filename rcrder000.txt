local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

-- ===== AUTHENTICATION & AUTO UPDATE SYSTEM ===== ‚úÖ
local GITHUB_RAW_URL = "https://raw.githubusercontent.com/lilyml2222-source/L/refs/heads/main/ww.json" -- GANTI INI
local SCRIPT_VERSION = "1.0.0"
local AUTH_DATA = nil

local function fetchGithubData()
	local success, result = pcall(function()
		return game:HttpGet(GITHUB_RAW_URL)
	end)
	if success then
		return HttpService:JSONDecode(result)
	else
		warn("Failed to fetch auth data:", result)
		return nil
	end
end

local function promptKey()
	local keyInput = ""
	
	-- Buat UI untuk input key
	local keyFrame = Instance.new("ScreenGui")
	keyFrame.Name = "KeySystem"
	keyFrame.ResetOnSpawn = false
	keyFrame.Parent = game.CoreGui
	
	local mainBox = Instance.new("Frame")
	mainBox.Size = UDim2.new(0, 300, 0, 180)
	mainBox.Position = UDim2.new(0.5, -150, 0.5, -90)
	mainBox.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
	mainBox.Parent = keyFrame
	local corner = Instance.new("UICorner"); corner.CornerRadius = UDim.new(0, 10); corner.Parent = mainBox
	
	local title = Instance.new("TextLabel")
	title.Size = UDim2.new(1, 0, 0, 40)
	title.BackgroundTransparency = 1
	title.Text = "üîê KEY AUTHENTICATION"
	title.TextColor3 = Color3.fromRGB(255, 215, 0)
	title.Font = Enum.Font.SourceSansBold
	title.TextSize = 18
	title.Parent = mainBox
	
	local usernameLabel = Instance.new("TextLabel")
	usernameLabel.Size = UDim2.new(0.9, 0, 0, 25)
	usernameLabel.Position = UDim2.new(0.05, 0, 0.3, 0)
	usernameLabel.BackgroundTransparency = 1
	usernameLabel.Text = "Username: " .. player.Name
	usernameLabel.TextColor3 = Color3.new(1, 1, 1)
	usernameLabel.TextSize = 14
	usernameLabel.TextXAlignment = Enum.TextXAlignment.Left
	usernameLabel.Parent = mainBox
	
	local keyBox = Instance.new("TextBox")
	keyBox.Size = UDim2.new(0.9, 0, 0, 35)
	keyBox.Position = UDim2.new(0.05, 0, 0.5, 0)
	keyBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
	keyBox.PlaceholderText = "Masukkan Key..."
	keyBox.Text = ""
	keyBox.TextColor3 = Color3.new(1, 1, 1)
	keyBox.TextSize = 14
	keyBox.Parent = mainBox
	local kc = Instance.new("UICorner"); kc.Parent = keyBox
	
	local submitBtn = Instance.new("TextButton")
	submitBtn.Size = UDim2.new(0.9, 0, 0, 35)
	submitBtn.Position = UDim2.new(0.05, 0, 0.75, 0)
	submitBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
	submitBtn.Text = "SUBMIT KEY"
	submitBtn.TextColor3 = Color3.new(1, 1, 1)
	submitBtn.Font = Enum.Font.SourceSansBold
	submitBtn.TextSize = 14
	submitBtn.Parent = mainBox
	local sc = Instance.new("UICorner"); sc.Parent = submitBtn
	
	local submitted = false
	
	submitBtn.MouseButton1Click:Connect(function()
		keyInput = keyBox.Text
		submitted = true
	end)
	
	-- Tunggu sampai submit
	while not submitted do
		wait(0.1)
	end
	
	keyFrame:Destroy()
	return keyInput
end

local function checkAuth()
	AUTH_DATA = fetchGithubData()
	if not AUTH_DATA then
		player:Kick("‚ùå Tidak dapat terhubung ke server authentication!")
		return false
	end
	
	-- Cek versi script
	if AUTH_DATA.version and AUTH_DATA.version ~= SCRIPT_VERSION then
		player:Kick("‚ö†Ô∏è SCRIPT OUTDATED!\n\nVersi Kamu: " .. SCRIPT_VERSION .. "\nVersi Terbaru: " .. AUTH_DATA.version .. "\n\nSilahkan update script!")
		return false
	end
	
	-- Cek username + key
	local playerName = player.Name
	local userKey = AUTH_DATA.users and AUTH_DATA.users[playerName]
	
	if not userKey then
		player:Kick("‚ùå ACCESS DENIED!\n\nUsername: " .. playerName .. "\n\nKamu tidak terdaftar!")
		return false
	end
	
	-- Minta input key
	local inputKey = promptKey()
	
	if inputKey ~= userKey then
		player:Kick("‚ùå WRONG KEY!\n\nKey yang kamu masukkan salah!\nCoba lagi atau hubungi admin.")
		return false
	end
	
	-- Sukses login
	StarterGui:SetCore("SendNotification", {
		Title = "‚úÖ AUTHENTICATED",
		Text = "Welcome, " .. playerName .. "!"
	})
	return true
end

-- Jalankan authentication
if not checkAuth() then
	return -- Stop script jika gagal auth
end

-- ===== END AUTHENTICATION ===== ‚úÖ


-- === STATE VARIABLES ===
local isRecording = false
local isReplaying = false
local isPaused = false 
local isReturning = false 
local recordingData = {}
local loadedData = nil
local startTime = 0
local reviewIndex = 0 
local isPreviewing = false
local previewConnection = nil
local previewIndex = 1
local selectedMergeFiles = {}

-- Variables untuk Playback TAS
local playbackIndex = 1
local playbackConnection = nil
local playbackSpeed = 1

-- --- 1. SETUP UI SYSTEM ---
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "Recorder_Ultimate_SmartStart"
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
screenGui.Parent = game.CoreGui 

-- Helper UI
local function createBtn(parent, name, text, color, pos, size)
	local btn = Instance.new("TextButton")
	btn.Name = name; btn.Size = size or UDim2.new(0.9, 0, 0, 35); btn.Position = pos
	btn.AnchorPoint = Vector2.new(0.5, 0); btn.BackgroundColor3 = color
	btn.Text = text; btn.TextColor3 = Color3.new(1,1,1)
	btn.Font = Enum.Font.SourceSansBold; btn.TextSize = 14; btn.Parent = parent
	local c = Instance.new("UICorner"); c.CornerRadius = UDim.new(0,6); c.Parent = btn
	return btn
end

-- UI ELEMENTS
local btnOpenMain = Instance.new("TextButton")
btnOpenMain.Size = UDim2.new(0, 50, 0, 50); btnOpenMain.Position = UDim2.new(0, 10, 0.4, 0)
btnOpenMain.BackgroundColor3 = Color3.fromRGB(40, 40, 40); btnOpenMain.Text = "MENU"
btnOpenMain.TextColor3 = Color3.fromRGB(255, 200, 0); btnOpenMain.Font = Enum.Font.FredokaOne; btnOpenMain.TextSize = 14
btnOpenMain.Visible = false; btnOpenMain.Parent = screenGui
local oc1 = Instance.new("UICorner"); oc1.CornerRadius = UDim.new(1,0); oc1.Parent = btnOpenMain
local os1 = Instance.new("UIStroke"); os1.Color = Color3.new(1,1,1); os1.Thickness = 2; os1.Parent = btnOpenMain

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainMenu"
mainFrame.Size = UDim2.new(0, 240, 0, 280)
mainFrame.Position = UDim2.new(0.5, -120, 0.3, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
mainFrame.Active = true; mainFrame.Draggable = true; mainFrame.Parent = screenGui
local mc = Instance.new("UICorner"); mc.CornerRadius = UDim.new(0, 10); mc.Parent = mainFrame

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, 0, 0, 40); titleLabel.BackgroundTransparency = 1
titleLabel.Text = "SMART TAS RECORDER"; titleLabel.TextColor3 = Color3.fromRGB(255, 215, 0)
titleLabel.Font = Enum.Font.SourceSansBold; titleLabel.TextSize = 18; titleLabel.Parent = mainFrame

local btnRecordStart = createBtn(mainFrame, "Start", "MULAI REKAMAN", Color3.fromRGB(0, 180, 0), UDim2.new(0.5, 0, 0.2, 0))
local btnMgr = createBtn(mainFrame, "Mgr", "FILE MANAGER", Color3.fromRGB(0, 120, 255), UDim2.new(0.5, 0, 0.4, 0))
local btnMinMain = createBtn(mainFrame, "Hide", "TUTUP MENU", Color3.fromRGB(80, 80, 80), UDim2.new(0.5, 0, 0.6, 0))
local btnReset = createBtn(mainFrame, "Reset", "RESET SCRIPT", Color3.fromRGB(200, 50, 50), UDim2.new(0.5, 0, 0.8, 0))

-- MINI BAR
local miniBar = Instance.new("Frame")
miniBar.Name = "MiniRecordingBar"
miniBar.Size = UDim2.new(0, 320, 0, 90) 
miniBar.Position = UDim2.new(0.5, -160, 0.82, 0)
miniBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
miniBar.BackgroundTransparency = 0.1
miniBar.Visible = false
miniBar.Active = true; miniBar.Draggable = true
miniBar.ZIndex = 5
miniBar.Parent = screenGui
local mbc = Instance.new("UICorner"); mbc.CornerRadius = UDim.new(0, 15); mbc.Parent = miniBar
local mbStroke = Instance.new("UIStroke"); mbStroke.Color = Color3.fromRGB(255, 170, 0); mbStroke.Thickness = 2; mbStroke.Parent = miniBar

local lblRecState = Instance.new("TextLabel")
lblRecState.Size = UDim2.new(1, 0, 0, 20); lblRecState.Position = UDim2.new(0,0,-0.3,0)
lblRecState.BackgroundTransparency = 1; lblRecState.Text = "STATUS: RECORDING..."
lblRecState.TextColor3 = Color3.fromRGB(0, 255, 0); lblRecState.Font = Enum.Font.SourceSansBold; lblRecState.TextSize = 16; lblRecState.Parent = miniBar

local btnMiniBack = Instance.new("TextButton"); btnMiniBack.Size = UDim2.new(0.15, 0, 0.5, 0); btnMiniBack.Position = UDim2.new(0.05, 0, 0.25, 0)
btnMiniBack.BackgroundColor3 = Color3.fromRGB(60,60,60); btnMiniBack.Text = "<<"; btnMiniBack.TextColor3 = Color3.new(1,1,1); btnMiniBack.Font = Enum.Font.FredokaOne; btnMiniBack.TextSize=20
btnMiniBack.Parent = miniBar; local c1 = Instance.new("UICorner"); c1.Parent = btnMiniBack

local btnMiniPause = Instance.new("TextButton"); btnMiniPause.Size = UDim2.new(0.25, 0, 0.5, 0); btnMiniPause.Position = UDim2.new(0.23, 0, 0.25, 0)
btnMiniPause.BackgroundColor3 = Color3.fromRGB(255,170,0); btnMiniPause.Text = "PAUSE"; btnMiniPause.TextColor3 = Color3.new(1,1,1); btnMiniPause.Font = Enum.Font.SourceSansBold
btnMiniPause.Parent = miniBar; local c2 = Instance.new("UICorner"); c2.Parent = btnMiniPause

local btnMiniFwd = Instance.new("TextButton"); btnMiniFwd.Size = UDim2.new(0.15, 0, 0.5, 0); btnMiniFwd.Position = UDim2.new(0.51, 0, 0.25, 0)
btnMiniFwd.BackgroundColor3 = Color3.fromRGB(60,60,60); btnMiniFwd.Text = ">>"; btnMiniFwd.TextColor3 = Color3.new(1,1,1); btnMiniFwd.Font = Enum.Font.FredokaOne; btnMiniFwd.TextSize=20
btnMiniFwd.Parent = miniBar; local c3 = Instance.new("UICorner"); c3.Parent = btnMiniFwd

local btnMiniStop = Instance.new("TextButton"); btnMiniStop.Size = UDim2.new(0.25, 0, 0.5, 0); btnMiniStop.Position = UDim2.new(0.70, 0, 0.25, 0)
btnMiniStop.BackgroundColor3 = Color3.fromRGB(255, 50, 50); btnMiniStop.Text = "DONE"; btnMiniStop.TextColor3 = Color3.new(1,1,1); btnMiniStop.Font = Enum.Font.SourceSansBold; btnMiniStop.TextSize=14
btnMiniStop.Parent = miniBar; local c4 = Instance.new("UICorner"); c4.Parent = btnMiniStop

-- SAVE FRAME (UPDATED WITH PREVIEW BUTTON)
local saveFrame = Instance.new("Frame")
saveFrame.Size = UDim2.new(0, 250, 0, 160); saveFrame.Position = UDim2.new(0.5, -125, 0.4, 0)
saveFrame.BackgroundColor3 = Color3.fromRGB(30,30,30); saveFrame.Visible = false
saveFrame.ZIndex = 100
saveFrame.Active = true
saveFrame.Draggable = true
saveFrame.Parent = screenGui
local sfc = Instance.new("UICorner"); sfc.Parent = saveFrame
local sfs = Instance.new("UIStroke"); sfs.Color = Color3.fromRGB(0,255,0); sfs.Thickness = 2; sfs.Parent = saveFrame

local lblSave = Instance.new("TextLabel"); lblSave.Text = "SIMPAN REKAMAN"; lblSave.Size=UDim2.new(1,0,0,30); lblSave.BackgroundTransparency=1; lblSave.TextColor3=Color3.new(1,1,1); lblSave.Font=Enum.Font.SourceSansBold; lblSave.Parent=saveFrame
local saveInput = Instance.new("TextBox")
saveInput.Size = UDim2.new(0.9,0,0,35); saveInput.Position = UDim2.new(0.05,0,0.25,0); saveInput.Parent = saveFrame
saveInput.PlaceholderText = "Masukkan Nama File..."; saveInput.BackgroundColor3=Color3.fromRGB(50,50,50); saveInput.TextColor3=Color3.new(1,1,1)
local btnPreviewRec = createBtn(saveFrame, "Preview", "PREVIEW REKAMAN", Color3.fromRGB(255, 170, 0), UDim2.new(0.5,0,0.55,0), UDim2.new(0.9,0,0,30))
local btnConfirmSave = createBtn(saveFrame, "SaveC", "SIMPAN FILE", Color3.fromRGB(0,200,0), UDim2.new(0.5,0,0.82,0), UDim2.new(0.9,0,0,30))
local btnCancelSave = Instance.new("TextButton")
btnCancelSave.Size = UDim2.new(0, 30, 0, 30)
btnCancelSave.Position = UDim2.new(0, 5, 0, 0)
btnCancelSave.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
btnCancelSave.Text = "X"
btnCancelSave.TextColor3 = Color3.new(1,1,1)
btnCancelSave.Font = Enum.Font.SourceSansBold
btnCancelSave.TextSize = 18
btnCancelSave.Parent = saveFrame
local csc = Instance.new("UICorner"); csc.Parent = btnCancelSave
-- PREVIEW FRAME
local previewFrame = Instance.new("Frame")
previewFrame.Name = "PreviewFrame"
previewFrame.Size = UDim2.new(0, 280, 0, 140)
previewFrame.Position = UDim2.new(0.5, -140, 0.15, 0)
previewFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
previewFrame.Visible = false; previewFrame.Active = true; previewFrame.Draggable = true
previewFrame.ZIndex = 101; previewFrame.Parent = screenGui
local pfc = Instance.new("UICorner"); pfc.CornerRadius = UDim.new(0, 10); pfc.Parent = previewFrame
local pfs = Instance.new("UIStroke"); pfs.Color = Color3.fromRGB(255, 170, 0); pfs.Thickness = 2; pfs.Parent = previewFrame

local previewTitle = Instance.new("TextLabel")
previewTitle.Size = UDim2.new(1, 0, 0, 30); previewTitle.BackgroundTransparency = 1
previewTitle.Text = "PREVIEW REKAMAN"; previewTitle.TextColor3 = Color3.fromRGB(255, 215, 0)
previewTitle.Font = Enum.Font.SourceSansBold; previewTitle.TextSize = 16; previewTitle.Parent = previewFrame

local lblPreviewInfo = Instance.new("TextLabel")
lblPreviewInfo.Size = UDim2.new(1, -20, 0, 25); lblPreviewInfo.Position = UDim2.new(0, 10, 0.25, 0)
lblPreviewInfo.BackgroundTransparency = 1; lblPreviewInfo.Text = "Frame: 0 / 0"
lblPreviewInfo.TextColor3 = Color3.new(1,1,1); lblPreviewInfo.TextSize = 12
lblPreviewInfo.TextXAlignment = Enum.TextXAlignment.Left; lblPreviewInfo.Parent = previewFrame

local btnPreviewPlay = createBtn(previewFrame, "PPlay", "PLAY ‚ñ∂Ô∏è", Color3.fromRGB(0, 180, 0), UDim2.new(0.25, 0, 0.55, 0), UDim2.new(0.4, 0, 0, 30))
local btnPreviewStop = createBtn(previewFrame, "PStop", "STOP ‚èπÔ∏è", Color3.fromRGB(200, 50, 50), UDim2.new(0.75, 0, 0.55, 0), UDim2.new(0.4, 0, 0, 30))
local btnClosePreview = createBtn(previewFrame, "PClose", "TUTUP", Color3.fromRGB(80, 80, 80), UDim2.new(0.5, 0, 0.85, 0), UDim2.new(0.9, 0, 0, 25))

-- PLAYER FRAME
local playFrame = Instance.new("Frame")
playFrame.Name = "PlayFrame"
playFrame.Size = UDim2.new(0, 200, 0, 180) 
playFrame.Position = UDim2.new(0.8, 0, 0.2, 0)
playFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
playFrame.Visible = false; playFrame.Active = true; playFrame.Draggable = true; playFrame.Parent = screenGui
local pc = Instance.new("UICorner"); pc.CornerRadius = UDim.new(0, 10); pc.Parent = playFrame

local playTitle = Instance.new("TextLabel")
playTitle.Size = UDim2.new(0.7, 0, 0, 25); playTitle.BackgroundTransparency = 1
playTitle.Text = "TAS PLAYER"; playTitle.TextColor3 = Color3.new(1,1,1); playTitle.Font = Enum.Font.SourceSansBold
playTitle.Parent = playFrame
local btnClosePlayer = Instance.new("TextButton"); btnClosePlayer.Size = UDim2.new(0,25,0,25); btnClosePlayer.Position = UDim2.new(1,-25,0,0); btnClosePlayer.Text="X"; btnClosePlayer.BackgroundTransparency=1; btnClosePlayer.TextColor3=Color3.new(1,1,1); btnClosePlayer.Parent=playFrame

local lblFileName = Instance.new("TextLabel")
lblFileName.Size = UDim2.new(1, 0, 0, 20); lblFileName.Position = UDim2.new(0,0,0.15,0); lblFileName.BackgroundTransparency = 1
lblFileName.Text = "File.json"; lblFileName.TextColor3 = Color3.fromRGB(200,200,200); lblFileName.TextSize = 12
lblFileName.Parent = playFrame

local lblStatusPlay = Instance.new("TextLabel")
lblStatusPlay.Size = UDim2.new(1, 0, 0, 20); lblStatusPlay.Position = UDim2.new(0,0,0.25,0); lblStatusPlay.BackgroundTransparency = 1
lblStatusPlay.Text = "Status: Ready"; lblStatusPlay.TextColor3 = Color3.fromRGB(100,255,100); lblStatusPlay.TextSize = 12
lblStatusPlay.Parent = playFrame

local btnSpeed = createBtn(playFrame, "Speed", "Speed: 1x", Color3.fromRGB(80, 80, 80), UDim2.new(0.5, 0, 0.42, 0), UDim2.new(0.9, 0, 0, 25))
local btnPlay = createBtn(playFrame, "Play", "PLAY", Color3.fromRGB(0, 200, 100), UDim2.new(0.5, 0, 0.60, 0), UDim2.new(0.9, 0, 0, 30))
local btnPlayPause = createBtn(playFrame, "PlayPause", "PAUSE", Color3.fromRGB(255, 170, 0), UDim2.new(0.5, 0, 0.78, 0), UDim2.new(0.9, 0, 0, 25))
btnPlayPause.Visible = false

-- MANAGER FRAME (UPDATED WITH MERGE & CONTINUE)
local mgrFrame = Instance.new("Frame")
mgrFrame.Name = "ManagerFrame"
mgrFrame.Size = UDim2.new(0, 320, 0, 400); mgrFrame.Position = UDim2.new(0.5, -160, 0.5, -200)
mgrFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40); mgrFrame.Visible = false
mgrFrame.Active = true; mgrFrame.Draggable = true; mgrFrame.Parent = screenGui
local mgc = Instance.new("UICorner"); mgc.CornerRadius = UDim.new(0, 10); mgc.Parent = mgrFrame

local mgrTitle = Instance.new("TextLabel")
mgrTitle.Size = UDim2.new(1, -40, 0, 30); mgrTitle.Position = UDim2.new(0,10,0,0)
mgrTitle.BackgroundTransparency = 1; mgrTitle.Text = "FILE MANAGER"; mgrTitle.TextColor3 = Color3.new(1,1,1)
mgrTitle.TextXAlignment = Enum.TextXAlignment.Left; mgrTitle.Font = Enum.Font.SourceSansBold
mgrTitle.Parent = mgrFrame

local btnCloseMgr = Instance.new("TextButton")
btnCloseMgr.Size = UDim2.new(0,30,0,30); btnCloseMgr.Position = UDim2.new(1,-30,0,0)
btnCloseMgr.BackgroundTransparency = 1; btnCloseMgr.Text = "X"; btnCloseMgr.TextColor3 = Color3.fromRGB(255,50,50)
btnCloseMgr.Font = Enum.Font.SourceSansBold; btnCloseMgr.TextSize = 20; btnCloseMgr.Parent = mgrFrame

local btnMergeMode = Instance.new("TextButton")
btnMergeMode.Size = UDim2.new(0.45, 0, 0, 28); btnMergeMode.Position = UDim2.new(0.03, 0, 0.08, 0)
btnMergeMode.BackgroundColor3 = Color3.fromRGB(100, 100, 255); btnMergeMode.Text = "MODE MERGE"
btnMergeMode.TextColor3 = Color3.new(1,1,1); btnMergeMode.Font = Enum.Font.SourceSansBold; btnMergeMode.TextSize = 12
btnMergeMode.Parent = mgrFrame; local bmc1 = Instance.new("UICorner"); bmc1.Parent = btnMergeMode

local btnConfirmMerge = Instance.new("TextButton")
btnConfirmMerge.Size = UDim2.new(0.45, 0, 0, 28); btnConfirmMerge.Position = UDim2.new(0.52, 0, 0.08, 0)
btnConfirmMerge.BackgroundColor3 = Color3.fromRGB(0, 200, 100); btnConfirmMerge.Text = "MERGE FILES"
btnConfirmMerge.TextColor3 = Color3.new(1,1,1); btnConfirmMerge.Font = Enum.Font.SourceSansBold; btnConfirmMerge.TextSize = 12
btnConfirmMerge.Visible = false; btnConfirmMerge.Parent = mgrFrame; local bmc2 = Instance.new("UICorner"); bmc2.Parent = btnConfirmMerge

local fileScroll = Instance.new("ScrollingFrame")
fileScroll.Size = UDim2.new(0.94, 0, 0.68, 0); fileScroll.Position = UDim2.new(0.03, 0, 0.16, 0)
fileScroll.BackgroundColor3 = Color3.fromRGB(30, 30, 30); fileScroll.Parent = mgrFrame
local uiList = Instance.new("UIListLayout"); uiList.Padding = UDim.new(0, 5); uiList.Parent = fileScroll

local renameFrame = Instance.new("Frame")
renameFrame.Size = UDim2.new(0, 200, 0, 100); renameFrame.Position = UDim2.new(0.5, -100, 0.4, 0)
renameFrame.BackgroundColor3 = Color3.fromRGB(20,20,20); renameFrame.Visible = false; renameFrame.ZIndex = 5; renameFrame.Parent = mgrFrame
local rc = Instance.new("UICorner"); rc.CornerRadius = UDim.new(0,8); rc.Parent = renameFrame
local renameInput = Instance.new("TextBox")
renameInput.Size = UDim2.new(0.9,0,0,30); renameInput.Position = UDim2.new(0.05,0,0.1,0); renameInput.BackgroundColor3 = Color3.fromRGB(50,50,50)
renameInput.TextColor3 = Color3.new(1,1,1); renameInput.Text = ""; renameInput.ZIndex = 6; renameInput.Parent = renameFrame
local btnConfirmRename = createBtn(renameFrame, "Conf", "CONFIRM", Color3.fromRGB(0,180,0), UDim2.new(0.5,0,0.7,0), UDim2.new(0.9,0,0,25))
local targetRenameFile = ""

-- MERGE SAVE FRAME
local mergeSaveFrame = Instance.new("Frame")
mergeSaveFrame.Size = UDim2.new(0, 250, 0, 120); mergeSaveFrame.Position = UDim2.new(0.5, -125, 0.4, 0)
mergeSaveFrame.BackgroundColor3 = Color3.fromRGB(30,30,30); mergeSaveFrame.Visible = false
mergeSaveFrame.ZIndex = 102; mergeSaveFrame.Parent = screenGui
local msfc = Instance.new("UICorner"); msfc.Parent = mergeSaveFrame
local msfs = Instance.new("UIStroke"); msfs.Color = Color3.fromRGB(100, 100, 255); msfs.Thickness = 2; msfs.Parent = mergeSaveFrame

local lblMergeSave = Instance.new("TextLabel"); lblMergeSave.Text = "SIMPAN MERGE"; lblMergeSave.Size=UDim2.new(1,0,0,30); lblMergeSave.BackgroundTransparency=1; lblMergeSave.TextColor3=Color3.new(1,1,1); lblMergeSave.Font=Enum.Font.SourceSansBold; lblMergeSave.Parent=mergeSaveFrame
local mergeSaveInput = Instance.new("TextBox")
mergeSaveInput.Size = UDim2.new(0.9,0,0,35); mergeSaveInput.Position = UDim2.new(0.05,0,0.3,0); mergeSaveInput.Parent = mergeSaveFrame
mergeSaveInput.PlaceholderText = "Nama File Merge..."; mergeSaveInput.BackgroundColor3=Color3.fromRGB(50,50,50); mergeSaveInput.TextColor3=Color3.new(1,1,1)
local btnConfirmMergeSave = createBtn(mergeSaveFrame, "MergeC", "SIMPAN MERGE", Color3.fromRGB(0,200,0), UDim2.new(0.5,0,0.75,0), UDim2.new(0.9,0,0,30))


-- --- 2. LOGIC SYSTEM ---

local function vectorToTable(vec) return {x = vec.X, y = vec.Y, z = vec.Z} end
local function updateChar()
	if not character or not character.Parent then
		character = player.Character
		if character then humanoid = character:FindFirstChild("Humanoid"); rootPart = character:FindFirstChild("HumanoidRootPart") end
	end
end

-- === LOGIKA VISUAL REVIEW ===
local function updateReviewVisual()
	if not recordingData[reviewIndex] then return end
	local frame = recordingData[reviewIndex]
	
	local pos = Vector3.new(frame.POS.x, frame.POS.y, frame.POS.z)
	rootPart.CFrame = CFrame.new(pos) * CFrame.Angles(0, frame.ROT, 0)
	rootPart.AssemblyLinearVelocity = Vector3.zero
	
	local stateName = string.upper(frame.STA)
	lblRecState.Text = "POS: " .. stateName .. string.format(" (%.1fs)", frame.TMI)
	
	if frame.STA then
		if frame.STA == "Jumping" then 
			humanoid:ChangeState(Enum.HumanoidStateType.Jumping); lblRecState.TextColor3 = Color3.fromRGB(255, 50, 50)
		elseif frame.STA == "Freefall" then 
			humanoid:ChangeState(Enum.HumanoidStateType.Freefall); lblRecState.TextColor3 = Color3.fromRGB(255, 100, 50)
		elseif frame.STA == "Climbing" then 
			humanoid:ChangeState(Enum.HumanoidStateType.Climbing); lblRecState.TextColor3 = Color3.fromRGB(50, 200, 255)
		elseif frame.STA == "Running" or frame.STA == "RunningNoPhysics" then
			humanoid:ChangeState(Enum.HumanoidStateType.Running); lblRecState.TextColor3 = Color3.fromRGB(50, 255, 50)
		else
			humanoid:ChangeState(Enum.HumanoidStateType.Landed); lblRecState.TextColor3 = Color3.fromRGB(255, 200, 50)
		end
	end
	
	if frame.VEL then
		local vel = Vector3.new(frame.VEL.x, frame.VEL.y, frame.VEL.z)
		if Vector3.new(vel.X, 0, vel.Z).Magnitude > 0.1 then humanoid:Move(vel, false) else humanoid:Move(Vector3.zero, false) end
	end
end

local function stepReview(direction)
	if not isPaused or #recordingData == 0 then return end
	reviewIndex = reviewIndex + (direction * 5)
	if reviewIndex < 1 then reviewIndex = 1 end
	if reviewIndex > #recordingData then reviewIndex = #recordingData end
	updateReviewVisual()
end

local function togglePause()
	if not isRecording then return end
	isPaused = not isPaused
	
	if isPaused then
		btnMiniPause.Text = "RESUME ‚ñ∂Ô∏è"
		btnMiniPause.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
		reviewIndex = #recordingData
		rootPart.Anchored = true
		updateReviewVisual()
	else
		if reviewIndex < #recordingData then
			for i = #recordingData, reviewIndex + 1, -1 do table.remove(recordingData, i) end
			StarterGui:SetCore("SendNotification", {Title="OVERWRITING", Text="Future deleted. Recording..."})
		end
		if #recordingData > 0 then startTime = os.clock() - recordingData[#recordingData].TMI else startTime = os.clock() end
		btnMiniPause.Text = "PAUSE ‚è∏Ô∏è"
		btnMiniPause.BackgroundColor3 = Color3.fromRGB(255, 170, 0)
		lblRecState.Text = "STATUS: RECORDING..."
		lblRecState.TextColor3 = Color3.fromRGB(0, 255, 0)
		rootPart.Anchored = false
		humanoid:Move(Vector3.zero, false)
	end
end

-- === PREVIEW SYSTEM ===
local function stopPreview()
	isPreviewing = false
	if previewConnection then previewConnection:Disconnect(); previewConnection = nil end
	updateChar()
	if rootPart then rootPart.Anchored = false end
	if humanoid then humanoid:ChangeState(Enum.HumanoidStateType.Landed); humanoid:Move(Vector3.zero, false) end
	btnPreviewPlay.Text = "PLAY ‚ñ∂Ô∏è"
	btnPreviewPlay.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
end

local function startPreview()
	if #recordingData == 0 then return end
	updateChar()
	
	isPreviewing = true
	previewIndex = 1
	local previewTime = 0
	local previewSpeed = 1
	
	btnPreviewPlay.Text = "PLAYING..."
	btnPreviewPlay.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
	
	rootPart.Anchored = false
	humanoid.AutoRotate = false
	humanoid.PlatformStand = false
	
	previewConnection = RunService.Heartbeat:Connect(function(dt)
		if not isPreviewing then return end
		if previewIndex > #recordingData then stopPreview(); return end
		
		previewTime = previewTime + (dt * previewSpeed)
		
		while previewIndex <= #recordingData and recordingData[previewIndex].TMI <= previewTime do
			local frame = recordingData[previewIndex]
			
			local pos = Vector3.new(frame.POS.x, frame.POS.y, frame.POS.z)
			rootPart.CFrame = CFrame.new(pos) * CFrame.Angles(0, frame.ROT, 0)
			
			if frame.VEL then
				local vel = Vector3.new(frame.VEL.x, frame.VEL.y, frame.VEL.z)
				rootPart.AssemblyLinearVelocity = vel
				if Vector3.new(vel.X, 0, vel.Z).Magnitude > 0.1 then
					humanoid:Move(vel, false)
				else
					humanoid:Move(Vector3.zero, false)
				end
			end
			
			if frame.STA then
				local s = frame.STA
				if s == "Jumping" then 
					humanoid:ChangeState(Enum.HumanoidStateType.Jumping); humanoid.Jump = true
				elseif s == "Freefall" then humanoid:ChangeState(Enum.HumanoidStateType.Freefall)
				elseif s == "Climbing" then humanoid:ChangeState(Enum.HumanoidStateType.Climbing)
				elseif s == "Landed" or s == "Running" then humanoid:ChangeState(Enum.HumanoidStateType.Running)
				end
			end
			
			lblPreviewInfo.Text = string.format("Frame: %d / %d (%.1fs)", previewIndex, #recordingData, frame.TMI)
			previewIndex = previewIndex + 1
		end
	end)
end
btnPreviewPlay.MouseButton1Click:Connect(function()
	if isPreviewing then
		stopPreview()
	else
		startPreview()
	end
end)

btnPreviewStop.MouseButton1Click:Connect(function()
	stopPreview()
	previewIndex = 1
	lblPreviewInfo.Text = "Frame: 0 / 0"
end)

btnClosePreview.MouseButton1Click:Connect(function()
	stopPreview()
	previewFrame.Visible = false
end)

btnPreviewRec.MouseButton1Click:Connect(function()
	if #recordingData == 0 then
		StarterGui:SetCore("SendNotification", {Title="ERROR", Text="Tidak ada rekaman untuk preview!"})
		return
	end
	previewFrame.Visible = true
	lblPreviewInfo.Text = string.format("Frame: 0 / %d", #recordingData)
end)

-- === MERGE SYSTEM ===
local isMergeMode = false

local function toggleMergeMode()
	isMergeMode = not isMergeMode
	selectedMergeFiles = {}
	
	if isMergeMode then
		btnMergeMode.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
		btnMergeMode.Text = "CANCEL MERGE"
		btnConfirmMerge.Visible = true
	else
		btnMergeMode.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
		btnMergeMode.Text = "MODE MERGE"
		btnConfirmMerge.Visible = false
	end
	
	refreshFiles()
end

btnMergeMode.MouseButton1Click:Connect(toggleMergeMode)

btnConfirmMerge.MouseButton1Click:Connect(function()
	if #selectedMergeFiles < 2 then
		StarterGui:SetCore("SendNotification", {Title="ERROR", Text="Pilih minimal 2 file untuk merge!"})
		return
	end
	
	local mergedData = {}
	local totalTime = 0
	
	for _, filepath in ipairs(selectedMergeFiles) do
		local success, data = pcall(function() return HttpService:JSONDecode(readfile(filepath)) end)
		if success and data then
			for _, frame in ipairs(data) do
				local newFrame = {}
				for k, v in pairs(frame) do newFrame[k] = v end
				newFrame.TMI = totalTime + frame.TMI
				table.insert(mergedData, newFrame)
			end
			if #data > 0 then
				totalTime = totalTime + data[#data].TMI
			end
		end
	end
	
	if #mergedData > 0 then
		recordingData = mergedData
		mergeSaveFrame.Visible = true
		mgrFrame.Visible = false
		isMergeMode = false
		selectedMergeFiles = {}
		btnMergeMode.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
		btnMergeMode.Text = "MODE MERGE"
		btnConfirmMerge.Visible = false
		
		StarterGui:SetCore("SendNotification", {Title="MERGE SUCCESS", Text=string.format("Total frames: %d", #mergedData)})
	end
end)

btnConfirmMergeSave.MouseButton1Click:Connect(function()
	local name = mergeSaveInput.Text; if name == "" then name = "merged" end
	name = name:gsub("%W", "") .. ".json"
	if writefile then writefile(name, HttpService:JSONEncode(recordingData)) end
	mergeSaveFrame.Visible = false
	mergeSaveInput.Text = ""
	refreshFiles()
	StarterGui:SetCore("SendNotification", {Title="SAVED", Text="Merge file saved: " .. name})
end)

-- EVENT HANDLERS
btnRecordStart.MouseButton1Click:Connect(function()
	if isReplaying then return end
	recordingData = {}; startTime = os.clock()
	isRecording = true; isPaused = false
	mainFrame.Visible = false; miniBar.Visible = true; saveFrame.Visible = false
	btnMiniPause.Text = "PAUSE ‚è∏Ô∏è"; btnMiniPause.BackgroundColor3 = Color3.fromRGB(255, 170, 0)
end)
btnMiniPause.MouseButton1Click:Connect(togglePause)

-- ===== HOLD & TAP UNTUK BACK BUTTON ===== ‚úÖ
local backHolding = false
local backConnection = nil

btnMiniBack.MouseButton1Down:Connect(function()
	backHolding = true
	stepReview(-1) -- Langsung mundur 1x saat ditekan
	
	wait(0.3) -- Delay sebelum mulai hold
	if backHolding then
		backConnection = RunService.Heartbeat:Connect(function()
			if backHolding and isPaused then
				stepReview(-1)
				wait(0.05) -- Kecepatan hold (makin kecil = makin cepat)
			end
		end)
	end
end)

btnMiniBack.MouseButton1Up:Connect(function()
	backHolding = false
	if backConnection then backConnection:Disconnect() end
end)

-- ===== HOLD & TAP UNTUK FORWARD BUTTON ===== ‚úÖ
local fwdHolding = false
local fwdConnection = nil

btnMiniFwd.MouseButton1Down:Connect(function()
	fwdHolding = true
	stepReview(1) -- Langsung maju 1x saat ditekan
	
	wait(0.3) -- Delay sebelum mulai hold
	if fwdHolding then
		fwdConnection = RunService.Heartbeat:Connect(function()
			if fwdHolding and isPaused then
				stepReview(1)
				wait(0.05) -- Kecepatan hold
			end
		end)
	end
end)

btnMiniFwd.MouseButton1Up:Connect(function()
	fwdHolding = false
	if fwdConnection then fwdConnection:Disconnect() end
end)

btnMiniStop.MouseButton1Click:Connect(function()
	if not isRecording then return end
	isRecording = false; isPaused = false
	rootPart.Anchored = false; miniBar.Visible = false; saveFrame.Visible = true
end)

btnConfirmSave.MouseButton1Click:Connect(function()
	local name = saveInput.Text; if name == "" then name = "rec" end
	name = name:gsub("%W", "") .. ".json"
	if writefile then writefile(name, HttpService:JSONEncode(recordingData)) end
	saveFrame.Visible = false; mainFrame.Visible = true; saveInput.Text = ""; refreshFiles()
end)
btnCancelSave.MouseButton1Click:Connect(function()
	saveFrame.Visible = false
	miniBar.Visible = true
	isRecording = true
	isPaused = false
	
	if #recordingData > 0 then
		startTime = os.clock() - recordingData[#recordingData].TMI
	else
		startTime = os.clock()
	end
	
	StarterGui:SetCore("SendNotification", {
		Title = "KEMBALI REKAM",
		Text = "Melanjutkan rekaman..."
	})
end)
RunService.Heartbeat:Connect(function()
	if not isRecording or isPaused or saveFrame.Visible then return end
	updateChar()
	if rootPart and humanoid then
		local _, rotY, _ = rootPart.CFrame:ToEulerAnglesYXZ()
		table.insert(recordingData, {
			HIP=humanoid.HipHeight, POS=vectorToTable(rootPart.Position), VEL=vectorToTable(rootPart.AssemblyLinearVelocity), 
			JUM=humanoid.Jump, STA=humanoid:GetState().Name, TMI=os.clock()-startTime, ROT=rotY
		})
	end
end)

-- FILE MANAGER
function refreshFiles()
	for _,v in pairs(fileScroll:GetChildren()) do if v:IsA("Frame") then v:Destroy() end end
	if listfiles then
		for _, file in pairs(listfiles("")) do
			if file:sub(-5) == ".json" then
				local pureName = file:match("([^/\\]+)$")
				local row = Instance.new("Frame")
				
				if isMergeMode then
					row.Size = UDim2.new(1,0,0,35)
				else
					row.Size = UDim2.new(1,0,0,35)
				end
				
				row.BackgroundColor3 = Color3.fromRGB(50,50,50)
				row.Parent = fileScroll
				local rc = Instance.new("UICorner"); rc.Parent = row
				
				if isMergeMode then
					local isSelected = false
					for _, selectedFile in ipairs(selectedMergeFiles) do
						if selectedFile == file then isSelected = true; break end
					end
					
					if isSelected then
						row.BackgroundColor3 = Color3.fromRGB(100, 255, 100)
					end
					
					local btnSelect = Instance.new("TextButton")
					btnSelect.Size = UDim2.new(1, 0, 1, 0)
					btnSelect.BackgroundTransparency = 1
					btnSelect.Text = "  " .. pureName
					btnSelect.TextXAlignment = Enum.TextXAlignment.Left
					btnSelect.TextColor3 = Color3.new(1,1,1)
					btnSelect.Parent = row
					
					btnSelect.MouseButton1Click:Connect(function()
						local found = false
						for i, selectedFile in ipairs(selectedMergeFiles) do
							if selectedFile == file then
								table.remove(selectedMergeFiles, i)
								found = true
								break
							end
						end
						
						if not found then
							table.insert(selectedMergeFiles, file)
						end
						
						refreshFiles()
					end)
				else
					local btnSelect = Instance.new("TextButton")
					btnSelect.Size = UDim2.new(0.42,0,1,0)
					btnSelect.BackgroundTransparency = 1
					btnSelect.Text = "  " .. pureName
					btnSelect.TextXAlignment = Enum.TextXAlignment.Left
					btnSelect.TextColor3 = Color3.new(1,1,1)
					btnSelect.Parent = row
					
					local btnContinue = Instance.new("TextButton")
					btnContinue.Size = UDim2.new(0.15,0,0.8,0)
					btnContinue.Position = UDim2.new(0.43,0,0.1,0)
					btnContinue.BackgroundColor3 = Color3.fromRGB(100, 200, 255)
					btnContinue.Text = "+"
					btnContinue.Font = Enum.Font.SourceSansBold
					btnContinue.TextSize = 18
					btnContinue.TextColor3 = Color3.new(1,1,1)
					btnContinue.Parent = row
					local cc = Instance.new("UICorner"); cc.Parent = btnContinue
					
					local btnEdit = Instance.new("TextButton")
					btnEdit.Size = UDim2.new(0.15,0,0.8,0)
					btnEdit.Position = UDim2.new(0.62,0,0.1,0)
					btnEdit.BackgroundColor3 = Color3.fromRGB(255,170,0)
					btnEdit.Text = "‚úèÔ∏è"
					btnEdit.Parent = row
					local ec = Instance.new("UICorner"); ec.Parent = btnEdit
					
					local btnDel = Instance.new("TextButton")
					btnDel.Size = UDim2.new(0.15,0,0.8,0)
					btnDel.Position = UDim2.new(0.8,0,0.1,0)
					btnDel.BackgroundColor3 = Color3.fromRGB(200,50,50)
					btnDel.Text = "üóëÔ∏è"
					btnDel.Parent = row
					local dc = Instance.new("UICorner"); dc.Parent = btnDel
					
					btnSelect.MouseButton1Click:Connect(function()
						local success, data = pcall(function() return HttpService:JSONDecode(readfile(file)) end)
						if success then loadedData = data; lblFileName.Text = pureName; playFrame.Visible = true; mgrFrame.Visible = false end
					end)
					
					btnContinue.MouseButton1Click:Connect(function()
						if isRecording or isReplaying then
							StarterGui:SetCore("SendNotification", {Title="ERROR", Text="Stop recording/playing first!"})
							return
						end
						
						local success, data = pcall(function() return HttpService:JSONDecode(readfile(file)) end)
						if success and data then
							recordingData = data
							if #recordingData > 0 then
								startTime = os.clock() - recordingData[#recordingData].TMI
							else
								startTime = os.clock()
							end
							
							isRecording = true
							isPaused = false
							mgrFrame.Visible = false
							miniBar.Visible = true
							btnMiniPause.Text = "PAUSE ‚è∏Ô∏è"
							btnMiniPause.BackgroundColor3 = Color3.fromRGB(255, 170, 0)
							
							StarterGui:SetCore("SendNotification", {
								Title="CONTINUE MODE", 
								Text=string.format("Continuing from frame %d", #recordingData)
							})
						end
					end)
					
					btnDel.MouseButton1Click:Connect(function() delfile(file); refreshFiles() end)
					btnEdit.MouseButton1Click:Connect(function() 
						targetRenameFile = file
						renameInput.Text = pureName:gsub(".json", "")
						renameFrame.Visible = true
					end)
				end
			end
		end
	end
end

btnConfirmRename.MouseButton1Click:Connect(function()
	if targetRenameFile ~= "" and renameInput.Text ~= "" then
		local newName = renameInput.Text:gsub("%W", "") .. ".json"
		writefile(newName, readfile(targetRenameFile)); delfile(targetRenameFile); refreshFiles(); renameFrame.Visible = false
	end
end)

btnMgr.MouseButton1Click:Connect(function() mgrFrame.Visible = true; refreshFiles() end)
btnCloseMgr.MouseButton1Click:Connect(function() 
	mgrFrame.Visible = false
	if isMergeMode then toggleMergeMode() end
end)

btnReset.MouseButton1Click:Connect(function() 
    recordingData={}; loadedData=nil; isRecording=false; isReplaying=false; isPaused=false; isPreviewing=false
    mainFrame.Visible=true; miniBar.Visible=false; playFrame.Visible=false; saveFrame.Visible=false; previewFrame.Visible=false
    if playbackConnection then playbackConnection:Disconnect() end
    if previewConnection then previewConnection:Disconnect() end
    if isMergeMode then toggleMergeMode() end
end)

btnMinMain.MouseButton1Click:Connect(function() mainFrame.Visible = false; btnOpenMain.Visible = true end)
btnOpenMain.MouseButton1Click:Connect(function() mainFrame.Visible = true; btnOpenMain.Visible = false end)

btnClosePlayer.MouseButton1Click:Connect(function() 
	playFrame.Visible = false
	isReplaying = false
	if playbackConnection then playbackConnection:Disconnect() end
end)

btnSpeed.MouseButton1Click:Connect(function()
	if playbackSpeed == 1 then playbackSpeed = 2 elseif playbackSpeed == 2 then playbackSpeed = 0.5 else playbackSpeed = 1 end
	btnSpeed.Text = "Speed: " .. playbackSpeed .. "x"
end)


-- === [CORE UPDATE] LOGIKA PLAYBACK (SMART START + SMART RESUME) ===

local function resetPlaybackState()
    isReplaying = false
    isReturning = false
    playbackIndex = 1
    if playbackConnection then playbackConnection:Disconnect() end
    
    local controls = require(player.PlayerScripts.PlayerModule):GetControls()
    controls:Enable()
    if humanoid then
        humanoid.PlatformStand = false
        humanoid.AutoRotate = true
        humanoid:ChangeState(Enum.HumanoidStateType.Landed)
    end
    if rootPart then rootPart.Anchored = false; rootPart.AssemblyLinearVelocity = Vector3.zero end
    
    btnPlay.Text = "PLAY"
    btnPlay.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
    lblStatusPlay.Text = "Status: Stopped"
    btnPlayPause.Visible = false
    isPaused = false
end

btnPlay.MouseButton1Click:Connect(function()
    if isReplaying then resetPlaybackState(); return end
    if not loadedData or #loadedData == 0 then return end
    
    updateChar()
    isReplaying = true
    isPaused = false
    isReturning = false
    
    local closestIndex = 1
    local closestDist = math.huge
    local myPos = rootPart.Position
    
    for i, data in ipairs(loadedData) do
        local fPos = Vector3.new(data.POS.x, data.POS.y, data.POS.z)
        local dist = (fPos - myPos).Magnitude
        if dist < closestDist then
            closestDist = dist
            closestIndex = i
        end
    end
    
    local currentTime = 0
    
    if closestDist < 50 then
        playbackIndex = closestIndex
        if playbackIndex > 1 then
            currentTime = loadedData[playbackIndex].TMI
        else
            currentTime = 0
        end
        lblStatusPlay.Text = "Smart Start: " .. math.floor((playbackIndex/#loadedData)*100) .. "%"
    else
        playbackIndex = 1
        currentTime = 0
        lblStatusPlay.Text = "Status: Playing (Start)..."
    end
    
    btnPlay.Text = "STOP"
    btnPlay.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    btnPlayPause.Visible = true
    btnPlayPause.Text = "PAUSE"
    
    local controls = require(player.PlayerScripts.PlayerModule):GetControls()
    controls:Disable()
    humanoid.AutoRotate = false
    humanoid.PlatformStand = false
    rootPart.Anchored = false 
    
    playbackConnection = RunService.Heartbeat:Connect(function(dt)
        if isPaused then return end

        if isReturning then
            local frame = loadedData[playbackIndex]
            local targetPos = Vector3.new(frame.POS.x, frame.POS.y, frame.POS.z)
            local diff = targetPos - rootPart.Position
            
            if diff.Magnitude > 3 then
                humanoid:Move(diff.Unit, false)
                humanoid:ChangeState(Enum.HumanoidStateType.Running)
            else
                isReturning = false
                humanoid.AutoRotate = false
                humanoid:Move(Vector3.zero, false)
                lblStatusPlay.Text = "Status: Playing (TAS)..."
            end
            return
        end

        if playbackIndex > #loadedData then
            resetPlaybackState()
            return
        end
        
        currentTime = currentTime + (dt * playbackSpeed)
        
        while playbackIndex <= #loadedData and loadedData[playbackIndex].TMI <= currentTime do
            local frame = loadedData[playbackIndex]
            
            local pos = Vector3.new(frame.POS.x, frame.POS.y, frame.POS.z)
            rootPart.CFrame = CFrame.new(pos) * CFrame.Angles(0, frame.ROT, 0)
            
            if frame.VEL then
                local vel = Vector3.new(frame.VEL.x, frame.VEL.y, frame.VEL.z)
                rootPart.AssemblyLinearVelocity = vel
                if Vector3.new(vel.X, 0, vel.Z).Magnitude > 0.1 then
                    humanoid:Move(vel, false)
                else
                    humanoid:Move(Vector3.zero, false)
                end
            end
            
            if frame.STA then
                local s = frame.STA
                if s == "Jumping" then 
                    humanoid:ChangeState(Enum.HumanoidStateType.Jumping); humanoid.Jump = true
                elseif s == "Freefall" then humanoid:ChangeState(Enum.HumanoidStateType.Freefall)
                elseif s == "Climbing" then humanoid:ChangeState(Enum.HumanoidStateType.Climbing)
                elseif s == "Landed" or s == "Running" then humanoid:ChangeState(Enum.HumanoidStateType.Running)
                end
            end
            playbackIndex = playbackIndex + 1
        end
    end)
end)

btnPlayPause.MouseButton1Click:Connect(function()
    if not isReplaying then return end
    isPaused = not isPaused
    
    local controls = require(player.PlayerScripts.PlayerModule):GetControls()
    
    if isPaused then
        btnPlayPause.Text = "RESUME"
        btnPlayPause.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
        lblStatusPlay.Text = "Status: PAUSED (Free Roam)"
        controls:Enable()
        rootPart.Anchored = false
        humanoid.AutoRotate = true
        humanoid:ChangeState(Enum.HumanoidStateType.Landed)
    else
        btnPlayPause.Text = "PAUSE"
        btnPlayPause.BackgroundColor3 = Color3.fromRGB(255, 170, 0)
        
        controls:Disable()
        
        local frame = loadedData[playbackIndex]
        local targetPos = Vector3.new(frame.POS.x, frame.POS.y, frame.POS.z)
        local dist = (targetPos - rootPart.Position).Magnitude
        
        if dist > 5 then
            isReturning = true
            humanoid.AutoRotate = true
            lblStatusPlay.Text = "Status: Returning to route..."
        else
            isReturning = false
            humanoid.AutoRotate = false
            lblStatusPlay.Text = "Status: Playing (TAS)..."
        end
    end
end)

-- STARTUP
wait(0.5)
mainFrame.Visible = true
StarterGui:SetCore("SendNotification", {
	Title = "TAS RECORDER PRO",
	Text = "Smart Start, Preview & Merge Ready!"
})